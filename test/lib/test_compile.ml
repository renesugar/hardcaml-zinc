open! Base
open Hardcaml
open Hardcaml_zinc
open! Expect_test_helpers_kernel
module Waveform = Hardcaml_waveterm.Waveform

let () = Caller_id.set_mode Full_trace

module M =
  Interp.Monad
    (struct
      let trace = false
    end)
    (Interp.State_poly)

module O = Interp.Opcodes (M)
module Sequential = Compile_hardware.Sequential
module Sim = Cyclesim.With_interface (Sequential.I) (Sequential.O)

let display_rules =
  Hardcaml_waveterm.Display_rules.(
    Rule.
      [ Sequential.I.(
          map port_names ~f:(fun n -> port_name_is n ~wave_format:(Bit_or Unsigned_int))
          |> to_list)
      ; Sequential.O.(
          map port_names ~f:(fun n -> port_name_is n ~wave_format:(Bit_or Unsigned_int))
          |> to_list)
      ; [ port_name_is "state" ~wave_format:Unsigned_int ]
      ]
    |> List.concat
    |> of_list)
;;

let simulate_instruction instr =
  let _, instr = O.dispatch instr Interp.State_poly.empty in
  let sim = Sim.create ~is_internal_port:(Fn.const true) (Sequential.compile instr) in
  let i : _ Sequential.I.t = Cyclesim.inputs sim in
  let waves, sim = Waveform.create sim in
  let set x i = x := Bits.consti ~width:(Bits.width !x) i in
  i.memory_in.read_available := Bits.vdd;
  set i.memory_in.read_data 10;
  i.program_in.read_available := Bits.vdd;
  set i.program_in.read_data 20;
  i.stack_in.read_available := Bits.vdd;
  set i.stack_in.read_data 30;
  i.memory_in.write_complete := Bits.vdd;
  i.program_in.write_complete := Bits.vdd;
  i.stack_in.write_complete := Bits.vdd;
  for _ = 0 to 5 do
    Cyclesim.cycle sim
  done;
  Waveform.print waves ~display_rules ~display_height:90 ~display_width:90
;;

let%expect_test "ACC0" =
  simulate_instruction ACC0;
  [%expect
    {|
    ┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────┐
    │clock             ││┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───│
    │                  ││    └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   │
    │clear             ││                                                                    │
    │                  ││────────────────────────────────────────────────                    │
    │si_read_available ││────────────────────────────────────────────────                    │
    │                  ││                                                                    │
    │                  ││────────────────────────────────────────────────                    │
    │si_read_data      ││ 30                                                                 │
    │                  ││────────────────────────────────────────────────                    │
    │mo_read           ││                                                                    │
    │                  ││────────────────────────────────────────────────                    │
    │                  ││────────────────────────────────────────────────                    │
    │mo_read_address   ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────                    │
    │mo_write          ││                                                                    │
    │                  ││────────────────────────────────────────────────                    │
    │                  ││────────────────────────────────────────────────                    │
    │mo_write_data     ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────                    │
    │                  ││────────────────────────────────────────────────                    │
    │mo_write_address  ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────                    │
    │po_read           ││                                                                    │
    │                  ││────────────────────────────────────────────────                    │
    │                  ││────────────────────────────────────────────────                    │
    │po_read_address   ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────                    │
    │po_write          ││                                                                    │
    │                  ││────────────────────────────────────────────────                    │
    │                  ││────────────────────────────────────────────────                    │
    │po_write_data     ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────                    │
    │                  ││────────────────────────────────────────────────                    │
    │po_write_address  ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────                    │
    │so_read           ││        ┌───────┐                                                   │
    │                  ││────────┘       └───────────────────────────────                    │
    │                  ││────────────────────────────────────────────────                    │
    │so_read_address   ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────                    │
    │so_write          ││                                                                    │
    │                  ││────────────────────────────────────────────────                    │
    │                  ││────────────────────────────────────────────────                    │
    │so_write_data     ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────                    │
    │                  ││────────────────────────────────────────────────                    │
    │so_write_address  ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────                    │
    │                  ││────────────────────────┬───────────────────────                    │
    │Accu              ││ 0                      │30                                         │
    │                  ││────────────────────────┴───────────────────────                    │
    │                  ││────────────────────────────────────────────────                    │
    │Env               ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────                    │
    │                  ││────────────────────────────────────────────────                    │
    │Pc                ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────                    │
    │                  ││────────────────────────────────────────────────                    │
    │Sp                ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────                    │
    │                  ││────────────────────────────────────────────────                    │
    │Extra_args        ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────                    │
    │                  ││────────────────────────────────────────────────                    │
    │Trapsp            ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────                    │
    │                  ││────────────────────────────────────────────────                    │
    │Global_data       ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────                    │
    │                  ││────────────────────────────────────────────────                    │
    │Atom_table        ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────                    │
    │                  ││────────────────────────────────────────────────                    │
    │Alloc_base        ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────                    │
    │                  ││────────────────────────────────────────────────                    │
    │Stack_high        ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────                    │
    │                  ││────────┬───────┬───────┬───────────────────────                    │
    │state             ││ 0      │1      │2      │3                                          │
    │                  ││────────┴───────┴───────┴───────────────────────                    │
    │                  ││                                                                    │
    │                  ││                                                                    │
    │                  ││                                                                    │
    │                  ││                                                                    │
    │                  ││                                                                    │
    │                  ││                                                                    │
    │                  ││                                                                    │
    └──────────────────┘└────────────────────────────────────────────────────────────────────┘ |}]
;;

let%expect_test "ACC1" =
  simulate_instruction ACC1;
  [%expect
    {|
    ┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────┐
    │clock             ││┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───│
    │                  ││    └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   │
    │clear             ││                                                                    │
    │                  ││────────────────────────────────────────────────                    │
    │si_read_available ││────────────────────────────────────────────────                    │
    │                  ││                                                                    │
    │                  ││────────────────────────────────────────────────                    │
    │si_read_data      ││ 30                                                                 │
    │                  ││────────────────────────────────────────────────                    │
    │mo_read           ││                                                                    │
    │                  ││────────────────────────────────────────────────                    │
    │                  ││────────────────────────────────────────────────                    │
    │mo_read_address   ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────                    │
    │mo_write          ││                                                                    │
    │                  ││────────────────────────────────────────────────                    │
    │                  ││────────────────────────────────────────────────                    │
    │mo_write_data     ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────                    │
    │                  ││────────────────────────────────────────────────                    │
    │mo_write_address  ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────                    │
    │po_read           ││                                                                    │
    │                  ││────────────────────────────────────────────────                    │
    │                  ││────────────────────────────────────────────────                    │
    │po_read_address   ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────                    │
    │po_write          ││                                                                    │
    │                  ││────────────────────────────────────────────────                    │
    │                  ││────────────────────────────────────────────────                    │
    │po_write_data     ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────                    │
    │                  ││────────────────────────────────────────────────                    │
    │po_write_address  ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────                    │
    │so_read           ││        ┌───────┐                                                   │
    │                  ││────────┘       └───────────────────────────────                    │
    │                  ││────────┬───────┬───────────────────────────────                    │
    │so_read_address   ││ 0      │1      │0                                                  │
    │                  ││────────┴───────┴───────────────────────────────                    │
    │so_write          ││                                                                    │
    │                  ││────────────────────────────────────────────────                    │
    │                  ││────────────────────────────────────────────────                    │
    │so_write_data     ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────                    │
    │                  ││────────────────────────────────────────────────                    │
    │so_write_address  ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────                    │
    │                  ││────────────────────────┬───────────────────────                    │
    │Accu              ││ 0                      │30                                         │
    │                  ││────────────────────────┴───────────────────────                    │
    │                  ││────────────────────────────────────────────────                    │
    │Env               ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────                    │
    │                  ││────────────────────────────────────────────────                    │
    │Pc                ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────                    │
    │                  ││────────────────────────────────────────────────                    │
    │Sp                ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────                    │
    │                  ││────────────────────────────────────────────────                    │
    │Extra_args        ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────                    │
    │                  ││────────────────────────────────────────────────                    │
    │Trapsp            ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────                    │
    │                  ││────────────────────────────────────────────────                    │
    │Global_data       ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────                    │
    │                  ││────────────────────────────────────────────────                    │
    │Atom_table        ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────                    │
    │                  ││────────────────────────────────────────────────                    │
    │Alloc_base        ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────                    │
    │                  ││────────────────────────────────────────────────                    │
    │Stack_high        ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────                    │
    │                  ││────────┬───────┬───────┬───────────────────────                    │
    │state             ││ 0      │1      │2      │3                                          │
    │                  ││────────┴───────┴───────┴───────────────────────                    │
    │                  ││                                                                    │
    │                  ││                                                                    │
    │                  ││                                                                    │
    │                  ││                                                                    │
    │                  ││                                                                    │
    │                  ││                                                                    │
    │                  ││                                                                    │
    └──────────────────┘└────────────────────────────────────────────────────────────────────┘ |}]
;;
