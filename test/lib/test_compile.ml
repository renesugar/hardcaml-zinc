open! Base
open Hardcaml
open Hardcaml_zinc
open! Expect_test_helpers_kernel
module Waveform = Hardcaml_waveterm.Waveform

(* let () = Caller_id.set_mode Full_trace *)

module M =
  Interp.Monad
    (struct
      let trace = false
    end)
    (Interp.State_poly)

module O = Interp.Opcodes (M)
module Sequential = Compile_hardware.Sequential
module Sim = Cyclesim.With_interface (Sequential.I) (Sequential.O)

let simulate_instruction instr =
  let _, instr = O.dispatch instr Interp.State_poly.empty in
  let sim = Sim.create ~is_internal_port:(Fn.const true) (Sequential.compile instr) in
  let i : _ Sequential.I.t = Cyclesim.inputs sim in
  let waves, sim = Waveform.create sim in
  let set x i = x := Bits.consti ~width:(Bits.width !x) i in
  i.memory_in.read_available := Bits.vdd;
  set i.memory_in.read_data 10;
  i.program_in.read_available := Bits.vdd;
  set i.program_in.read_data 20;
  i.stack_in.read_available := Bits.vdd;
  set i.stack_in.read_data 30;
  i.memory_in.write_complete := Bits.vdd;
  i.program_in.write_complete := Bits.vdd;
  i.stack_in.write_complete := Bits.vdd;
  for _ = 0 to 18 do
    Cyclesim.cycle sim
  done;
  let display_rules, display_height = Instruction_display_rules.create instr.cmd in
  Waveform.print waves ~display_rules ~wave_width:1 ~display_height ~display_width:90
;;

let%expect_test "ACC0" =
  simulate_instruction ACC0;
  [%expect
    {|
    ┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────┐
    │clock             ││┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ │
    │                  ││  └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─│
    │                  ││────┬───┬───┬───────────────────────────────────────────────────────│
    │state             ││ 0  │1  │2  │3                                                      │
    │                  ││────┴───┴───┴───────────────────────────────────────────────────────│
    │                  ││────────────┬───────────────────────────────────────────────────────│
    │Accu              ││ 0          │30                                                     │
    │                  ││────────────┴───────────────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────────────────────────│
    │Sp                ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────────────────────────│
    │so_read           ││    ┌───┐                                                           │
    │                  ││────┘   └───────────────────────────────────────────────────────────│
    │si_read_available ││────────────────────────────────────────────────────────────────────│
    │                  ││                                                                    │
    │                  ││────────────────────────────────────────────────────────────────────│
    │si_read_data      ││ 30                                                                 │
    │                  ││────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────────────────────────│
    │so_read_address   ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────────────────────────│
    └──────────────────┘└────────────────────────────────────────────────────────────────────┘ |}]
;;

let%expect_test "ACC1" =
  simulate_instruction ACC1;
  [%expect
    {|
    ┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────┐
    │clock             ││┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ │
    │                  ││  └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─│
    │                  ││────┬───┬───┬───────────────────────────────────────────────────────│
    │state             ││ 0  │1  │2  │3                                                      │
    │                  ││────┴───┴───┴───────────────────────────────────────────────────────│
    │                  ││────────────┬───────────────────────────────────────────────────────│
    │Accu              ││ 0          │30                                                     │
    │                  ││────────────┴───────────────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────────────────────────│
    │Sp                ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────────────────────────│
    │so_read           ││    ┌───┐                                                           │
    │                  ││────┘   └───────────────────────────────────────────────────────────│
    │si_read_available ││────────────────────────────────────────────────────────────────────│
    │                  ││                                                                    │
    │                  ││────────────────────────────────────────────────────────────────────│
    │si_read_data      ││ 30                                                                 │
    │                  ││────────────────────────────────────────────────────────────────────│
    │                  ││────┬───┬───────────────────────────────────────────────────────────│
    │so_read_address   ││ 0  │1  │0                                                          │
    │                  ││────┴───┴───────────────────────────────────────────────────────────│
    └──────────────────┘└────────────────────────────────────────────────────────────────────┘ |}]
;;

let%expect_test "ACC" =
  simulate_instruction ACC;
  [%expect
    {|
    ┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────┐
    │clock             ││┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ │
    │                  ││  └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─│
    │                  ││────┬───┬───┬───┬───┬───┬───┬───────────────────────────────────────│
    │state             ││ 0  │1  │2  │3  │4  │5  │6  │7                                      │
    │                  ││────┴───┴───┴───┴───┴───┴───┴───────────────────────────────────────│
    │                  ││────────────────────────────┬───────────────────────────────────────│
    │Accu              ││ 0                          │30                                     │
    │                  ││────────────────────────────┴───────────────────────────────────────│
    │                  ││────────────────┬───────────────────────────────────────────────────│
    │Pc                ││ 0              │4                                                  │
    │                  ││────────────────┴───────────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────────────────────────│
    │Sp                ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────────────────────────│
    │po_read           ││    ┌───┐                                                           │
    │                  ││────┘   └───────────────────────────────────────────────────────────│
    │pi_read_available ││────────────────────────────────────────────────────────────────────│
    │                  ││                                                                    │
    │                  ││────────────────────────────────────────────────────────────────────│
    │pi_read_data      ││ 20                                                                 │
    │                  ││────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────────────────────────│
    │po_read_address   ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────────────────────────│
    │so_read           ││                    ┌───┐                                           │
    │                  ││────────────────────┘   └───────────────────────────────────────────│
    │si_read_available ││────────────────────────────────────────────────────────────────────│
    │                  ││                                                                    │
    │                  ││────────────────────────────────────────────────────────────────────│
    │si_read_data      ││ 30                                                                 │
    │                  ││────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────────────────────────│
    │so_read_address   ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────────────────────────│
    └──────────────────┘└────────────────────────────────────────────────────────────────────┘ |}]
;;

let%expect_test "PUSH" =
  simulate_instruction PUSH;
  [%expect
    {|
    ┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────┐
    │clock             ││┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ │
    │                  ││  └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─│
    │                  ││────┬───┬───┬───┬───┬───────────────────────────────────────────────│
    │state             ││ 0  │1  │2  │3  │4  │5                                              │
    │                  ││────┴───┴───┴───┴───┴───────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────────────────────────│
    │Accu              ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────────────────────────│
    │                  ││────────────┬───────────────────────────────────────────────────────│
    │Sp                ││ 0          │18446744073709551608                                   │
    │                  ││────────────┴───────────────────────────────────────────────────────│
    │so_write          ││                ┌───┐                                               │
    │                  ││────────────────┘   └───────────────────────────────────────────────│
    │si_write_complete ││────────────────────────────────────────────────────────────────────│
    │                  ││                                                                    │
    │                  ││────────────────────────────────────────────────────────────────────│
    │so_write_data     ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────────────────────────│
    │                  ││────────────────┬───┬───────────────────────────────────────────────│
    │so_write_address  ││ 0              │23.│0                                              │
    │                  ││────────────────┴───┴───────────────────────────────────────────────│
    └──────────────────┘└────────────────────────────────────────────────────────────────────┘ |}]
;;

let%expect_test "PUSHACC0" =
  simulate_instruction PUSHACC0;
  [%expect
    {|
    ┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────┐
    │clock             ││┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ │
    │                  ││  └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─│
    │                  ││────┬───┬───┬───┬───┬───┬───┬───┬───────────────────────────────────│
    │state             ││ 0  │1  │2  │3  │4  │5  │6  │7  │8                                  │
    │                  ││────┴───┴───┴───┴───┴───┴───┴───┴───────────────────────────────────│
    │                  ││────────────────────────────────┬───────────────────────────────────│
    │Accu              ││ 0                              │30                                 │
    │                  ││────────────────────────────────┴───────────────────────────────────│
    │                  ││────────────┬───────────────────────────────────────────────────────│
    │Sp                ││ 0          │18446744073709551608                                   │
    │                  ││────────────┴───────────────────────────────────────────────────────│
    │so_write          ││                ┌───┐                                               │
    │                  ││────────────────┘   └───────────────────────────────────────────────│
    │si_write_complete ││────────────────────────────────────────────────────────────────────│
    │                  ││                                                                    │
    │                  ││────────────────────────────────────────────────────────────────────│
    │so_write_data     ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────────────────────────│
    │                  ││────────────────┬───┬───────────────────────────────────────────────│
    │so_write_address  ││ 0              │23.│0                                              │
    │                  ││────────────────┴───┴───────────────────────────────────────────────│
    │so_read           ││                        ┌───┐                                       │
    │                  ││────────────────────────┘   └───────────────────────────────────────│
    │si_read_available ││────────────────────────────────────────────────────────────────────│
    │                  ││                                                                    │
    │                  ││────────────────────────────────────────────────────────────────────│
    │si_read_data      ││ 30                                                                 │
    │                  ││────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────┬───┬───────────────────────────────────────│
    │so_read_address   ││ 0                      │23.│0                                      │
    │                  ││────────────────────────┴───┴───────────────────────────────────────│
    └──────────────────┘└────────────────────────────────────────────────────────────────────┘ |}]
;;

let%expect_test "PUSHACC0" =
  simulate_instruction PUSHACC;
  [%expect
    {|
    ┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────┐
    │clock             ││┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ │
    │                  ││  └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─│
    │                  ││────┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───────────────────│
    │state             ││ 0  │1  │2  │3  │4  │5  │6  │7  │8  │9  │10 │11 │12                 │
    │                  ││────┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───────────────────│
    │                  ││────────────────────────────────────────────────┬───────────────────│
    │Accu              ││ 0                                              │30                 │
    │                  ││────────────────────────────────────────────────┴───────────────────│
    │                  ││────────────────┬───────────────────────────────────────────────────│
    │Pc                ││ 0              │4                                                  │
    │                  ││────────────────┴───────────────────────────────────────────────────│
    │                  ││────────────────────────────┬───────────────────────────────────────│
    │Sp                ││ 0                          │18446744073709551608                   │
    │                  ││────────────────────────────┴───────────────────────────────────────│
    │po_read           ││    ┌───┐                                                           │
    │                  ││────┘   └───────────────────────────────────────────────────────────│
    │pi_read_available ││────────────────────────────────────────────────────────────────────│
    │                  ││                                                                    │
    │                  ││────────────────────────────────────────────────────────────────────│
    │pi_read_data      ││ 20                                                                 │
    │                  ││────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────────────────────────│
    │po_read_address   ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────────────────────────│
    │so_write          ││                                ┌───┐                               │
    │                  ││────────────────────────────────┘   └───────────────────────────────│
    │si_write_complete ││────────────────────────────────────────────────────────────────────│
    │                  ││                                                                    │
    │                  ││────────────────────────────────────────────────────────────────────│
    │so_write_data     ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────────────┬───┬───────────────────────────────│
    │so_write_address  ││ 0                              │23.│0                              │
    │                  ││────────────────────────────────┴───┴───────────────────────────────│
    │so_read           ││                                        ┌───┐                       │
    │                  ││────────────────────────────────────────┘   └───────────────────────│
    │si_read_available ││────────────────────────────────────────────────────────────────────│
    │                  ││                                                                    │
    │                  ││────────────────────────────────────────────────────────────────────│
    │si_read_data      ││ 30                                                                 │
    │                  ││────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────────────────────┬───┬───────────────────────│
    │so_read_address   ││ 0                                      │23.│0                      │
    │                  ││────────────────────────────────────────┴───┴───────────────────────│
    └──────────────────┘└────────────────────────────────────────────────────────────────────┘ |}]
;;

let%expect_test "POP" =
  simulate_instruction POP;
  [%expect
    {|
    ┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────┐
    │clock             ││┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ │
    │                  ││  └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─│
    │                  ││────┬───┬───┬───┬───┬───┬───────────────────────────────────────────│
    │state             ││ 0  │1  │2  │3  │4  │5  │6                                          │
    │                  ││────┴───┴───┴───┴───┴───┴───────────────────────────────────────────│
    │                  ││────────────────┬───────────────────────────────────────────────────│
    │Pc                ││ 0              │4                                                  │
    │                  ││────────────────┴───────────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────────────────────────│
    │Sp                ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────────────────────────│
    │po_read           ││    ┌───┐                                                           │
    │                  ││────┘   └───────────────────────────────────────────────────────────│
    │pi_read_available ││────────────────────────────────────────────────────────────────────│
    │                  ││                                                                    │
    │                  ││────────────────────────────────────────────────────────────────────│
    │pi_read_data      ││ 20                                                                 │
    │                  ││────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────────────────────────│
    │po_read_address   ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────────────────────────│
    └──────────────────┘└────────────────────────────────────────────────────────────────────┘ |}]
;;

let%expect_test "ASSIGN" =
  simulate_instruction ASSIGN;
  [%expect
    {|
    ┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────┐
    │clock             ││┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ │
    │                  ││  └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─│
    │                  ││────┬───┬───┬───┬───┬───┬───┬───┬───────────────────────────────────│
    │state             ││ 0  │1  │2  │3  │4  │5  │6  │7  │8                                  │
    │                  ││────┴───┴───┴───┴───┴───┴───┴───┴───────────────────────────────────│
    │                  ││────────────────────────────────┬───────────────────────────────────│
    │Accu              ││ 0                              │1                                  │
    │                  ││────────────────────────────────┴───────────────────────────────────│
    │                  ││────────────────┬───────────────────────────────────────────────────│
    │Pc                ││ 0              │4                                                  │
    │                  ││────────────────┴───────────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────────────────────────│
    │Sp                ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────────────────────────│
    │po_read           ││    ┌───┐                                                           │
    │                  ││────┘   └───────────────────────────────────────────────────────────│
    │pi_read_available ││────────────────────────────────────────────────────────────────────│
    │                  ││                                                                    │
    │                  ││────────────────────────────────────────────────────────────────────│
    │pi_read_data      ││ 20                                                                 │
    │                  ││────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────────────────────────│
    │po_read_address   ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────────────────────────│
    │so_write          ││                        ┌───┐                                       │
    │                  ││────────────────────────┘   └───────────────────────────────────────│
    │si_write_complete ││────────────────────────────────────────────────────────────────────│
    │                  ││                                                                    │
    │                  ││────────────────────────────────────────────────────────────────────│
    │so_write_data     ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────────────────────────│
    │so_write_address  ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────────────────────────│
    └──────────────────┘└────────────────────────────────────────────────────────────────────┘ |}]
;;

let%expect_test "ENVACC1" =
  simulate_instruction ENVACC1;
  [%expect
    {|
    ┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────┐
    │clock             ││┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ │
    │                  ││  └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─│
    │                  ││────┬───┬───┬───────────────────────────────────────────────────────│
    │state             ││ 0  │1  │2  │3                                                      │
    │                  ││────┴───┴───┴───────────────────────────────────────────────────────│
    │                  ││────────────┬───────────────────────────────────────────────────────│
    │Accu              ││ 0          │10                                                     │
    │                  ││────────────┴───────────────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────────────────────────│
    │Env               ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────────────────────────│
    │mo_read           ││    ┌───┐                                                           │
    │                  ││────┘   └───────────────────────────────────────────────────────────│
    │mi_read_available ││────────────────────────────────────────────────────────────────────│
    │                  ││                                                                    │
    │                  ││────────────────────────────────────────────────────────────────────│
    │mi_read_data      ││ 10                                                                 │
    │                  ││────────────────────────────────────────────────────────────────────│
    │                  ││────┬───┬───────────────────────────────────────────────────────────│
    │mo_read_address   ││ 0  │1  │0                                                          │
    │                  ││────┴───┴───────────────────────────────────────────────────────────│
    └──────────────────┘└────────────────────────────────────────────────────────────────────┘ |}]
;;

let%expect_test "ENVACC" =
  simulate_instruction ENVACC;
  [%expect
    {|
    ┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────┐
    │clock             ││┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ │
    │                  ││  └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─│
    │                  ││────┬───┬───┬───┬───┬───┬───┬───────────────────────────────────────│
    │state             ││ 0  │1  │2  │3  │4  │5  │6  │7                                      │
    │                  ││────┴───┴───┴───┴───┴───┴───┴───────────────────────────────────────│
    │                  ││────────────────────────────┬───────────────────────────────────────│
    │Accu              ││ 0                          │10                                     │
    │                  ││────────────────────────────┴───────────────────────────────────────│
    │                  ││────────────────────────────────────────────────────────────────────│
    │Env               ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────────────────────────│
    │                  ││────────────────┬───────────────────────────────────────────────────│
    │Pc                ││ 0              │4                                                  │
    │                  ││────────────────┴───────────────────────────────────────────────────│
    │mo_read           ││                    ┌───┐                                           │
    │                  ││────────────────────┘   └───────────────────────────────────────────│
    │mi_read_available ││────────────────────────────────────────────────────────────────────│
    │                  ││                                                                    │
    │                  ││────────────────────────────────────────────────────────────────────│
    │mi_read_data      ││ 10                                                                 │
    │                  ││────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────────────────────────│
    │mo_read_address   ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────────────────────────│
    │po_read           ││    ┌───┐                                                           │
    │                  ││────┘   └───────────────────────────────────────────────────────────│
    │pi_read_available ││────────────────────────────────────────────────────────────────────│
    │                  ││                                                                    │
    │                  ││────────────────────────────────────────────────────────────────────│
    │pi_read_data      ││ 20                                                                 │
    │                  ││────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────────────────────────│
    │po_read_address   ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────────────────────────│
    └──────────────────┘└────────────────────────────────────────────────────────────────────┘ |}]
;;

let%expect_test "PUSHENVACC1" =
  simulate_instruction PUSHENVACC1;
  [%expect
    {|
    ┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────┐
    │clock             ││┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ │
    │                  ││  └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─│
    │                  ││────┬───┬───┬───┬───┬───┬───┬───┬───────────────────────────────────│
    │state             ││ 0  │1  │2  │3  │4  │5  │6  │7  │8                                  │
    │                  ││────┴───┴───┴───┴───┴───┴───┴───┴───────────────────────────────────│
    │                  ││────────────────────────────────┬───────────────────────────────────│
    │Accu              ││ 0                              │10                                 │
    │                  ││────────────────────────────────┴───────────────────────────────────│
    │                  ││────────────────────────────────────────────────────────────────────│
    │Env               ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────────────────────────│
    │                  ││────────────┬───────────────────────────────────────────────────────│
    │Sp                ││ 0          │18446744073709551608                                   │
    │                  ││────────────┴───────────────────────────────────────────────────────│
    │mo_read           ││                        ┌───┐                                       │
    │                  ││────────────────────────┘   └───────────────────────────────────────│
    │mi_read_available ││────────────────────────────────────────────────────────────────────│
    │                  ││                                                                    │
    │                  ││────────────────────────────────────────────────────────────────────│
    │mi_read_data      ││ 10                                                                 │
    │                  ││────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────┬───┬───────────────────────────────────────│
    │mo_read_address   ││ 0                      │1  │0                                      │
    │                  ││────────────────────────┴───┴───────────────────────────────────────│
    │so_write          ││                ┌───┐                                               │
    │                  ││────────────────┘   └───────────────────────────────────────────────│
    │si_write_complete ││────────────────────────────────────────────────────────────────────│
    │                  ││                                                                    │
    │                  ││────────────────────────────────────────────────────────────────────│
    │so_write_data     ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────────────────────────│
    │                  ││────────────────┬───┬───────────────────────────────────────────────│
    │so_write_address  ││ 0              │23.│0                                              │
    │                  ││────────────────┴───┴───────────────────────────────────────────────│
    └──────────────────┘└────────────────────────────────────────────────────────────────────┘ |}]
;;

let%expect_test "PUSHENVACC" =
  simulate_instruction PUSHENVACC;
  [%expect
    {|
    ┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────┐
    │clock             ││┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ │
    │                  ││  └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─│
    │                  ││────┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───────────────────│
    │state             ││ 0  │1  │2  │3  │4  │5  │6  │7  │8  │9  │10 │11 │12                 │
    │                  ││────┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───────────────────│
    │                  ││────────────────────────────────────────────────┬───────────────────│
    │Accu              ││ 0                                              │10                 │
    │                  ││────────────────────────────────────────────────┴───────────────────│
    │                  ││────────────────────────────────────────────────────────────────────│
    │Env               ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────────────────────────│
    │                  ││────────────────┬───────────────────────────────────────────────────│
    │Pc                ││ 0              │4                                                  │
    │                  ││────────────────┴───────────────────────────────────────────────────│
    │                  ││────────────────────────────┬───────────────────────────────────────│
    │Sp                ││ 0                          │18446744073709551608                   │
    │                  ││────────────────────────────┴───────────────────────────────────────│
    │mo_read           ││                                        ┌───┐                       │
    │                  ││────────────────────────────────────────┘   └───────────────────────│
    │mi_read_available ││────────────────────────────────────────────────────────────────────│
    │                  ││                                                                    │
    │                  ││────────────────────────────────────────────────────────────────────│
    │mi_read_data      ││ 10                                                                 │
    │                  ││────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────────────────────────│
    │mo_read_address   ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────────────────────────│
    │po_read           ││    ┌───┐                                                           │
    │                  ││────┘   └───────────────────────────────────────────────────────────│
    │pi_read_available ││────────────────────────────────────────────────────────────────────│
    │                  ││                                                                    │
    │                  ││────────────────────────────────────────────────────────────────────│
    │pi_read_data      ││ 20                                                                 │
    │                  ││────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────────────────────────│
    │po_read_address   ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────────────────────────│
    │so_write          ││                                ┌───┐                               │
    │                  ││────────────────────────────────┘   └───────────────────────────────│
    │si_write_complete ││────────────────────────────────────────────────────────────────────│
    │                  ││                                                                    │
    │                  ││────────────────────────────────────────────────────────────────────│
    │so_write_data     ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────────────┬───┬───────────────────────────────│
    │so_write_address  ││ 0                              │23.│0                              │
    │                  ││────────────────────────────────┴───┴───────────────────────────────│
    └──────────────────┘└────────────────────────────────────────────────────────────────────┘ |}]
;;

let%expect_test "PUSH_RETADDR" =
  simulate_instruction PUSH_RETADDR;
  [%expect
    {|
    ┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────┐
    │clock             ││┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ │
    │                  ││  └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─│
    │                  ││────┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───│
    │state             ││ 0  │1  │2  │3  │4  │5  │6  │7  │8  │9  │10 │11 │12 │13 │14 │15 │16 │
    │                  ││────┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───│
    │                  ││────────────────────────────────────────────────────────────────────│
    │Env               ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────────────────┬───────│
    │Pc                ││ 0                                                          │4      │
    │                  ││────────────────────────────────────────────────────────────┴───────│
    │                  ││────────────┬───────────────────┬───────────────────────────────────│
    │Sp                ││ 0          │184467440737095516.│18446744073709551600               │
    │                  ││────────────┴───────────────────┴───────────────────────────────────│
    │                  ││────────────────────────────────────────────────────────────────────│
    │Extra_args        ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────────────────────────│
    │po_read           ││                                                ┌───┐               │
    │                  ││────────────────────────────────────────────────┘   └───────────────│
    │pi_read_available ││────────────────────────────────────────────────────────────────────│
    │                  ││                                                                    │
    │                  ││────────────────────────────────────────────────────────────────────│
    │pi_read_data      ││ 20                                                                 │
    │                  ││────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────────────────────────│
    │po_read_address   ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────────────────────────│
    │so_write          ││                ┌───┐               ┌───┐                           │
    │                  ││────────────────┘   └───────────────┘   └───────────────────────────│
    │si_write_complete ││────────────────────────────────────────────────────────────────────│
    │                  ││                                                                    │
    │                  ││────────────────┬───┬───────────────────────────────────────────────│
    │so_write_data     ││ 0              │1  │0                                              │
    │                  ││────────────────┴───┴───────────────────────────────────────────────│
    │                  ││────────────────┬───┬───────────────┬───┬───────────────────────────│
    │so_write_address  ││ 0              │23.│0              │23.│0                          │
    │                  ││────────────────┴───┴───────────────┴───┴───────────────────────────│
    └──────────────────┘└────────────────────────────────────────────────────────────────────┘ |}]
;;

let%expect_test "APPLY" =
  simulate_instruction APPLY;
  [%expect
    {|
    ┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────┐
    │clock             ││┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ │
    │                  ││  └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─│
    │                  ││────┬───┬───┬───┬───┬───┬───┬───┬───┬───────────────────────────────│
    │state             ││ 0  │1  │2  │3  │4  │5  │6  │7  │8  │9                              │
    │                  ││────┴───┴───┴───┴───┴───┴───┴───┴───┴───────────────────────────────│
    │                  ││────────────────────────────────────────────────────────────────────│
    │Accu              ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────────────────────────│
    │Env               ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────────────────────────│
    │                  ││────────────────┬───────────────┬───────────────────────────────────│
    │Pc                ││ 0              │4              │10                                 │
    │                  ││────────────────┴───────────────┴───────────────────────────────────│
    │                  ││────────────────────┬───────────────────────────────────────────────│
    │Extra_args        ││ 0                  │18446744073709551615                           │
    │                  ││────────────────────┴───────────────────────────────────────────────│
    │mo_read           ││                        ┌───┐                                       │
    │                  ││────────────────────────┘   └───────────────────────────────────────│
    │mi_read_available ││────────────────────────────────────────────────────────────────────│
    │                  ││                                                                    │
    │                  ││────────────────────────────────────────────────────────────────────│
    │mi_read_data      ││ 10                                                                 │
    │                  ││────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────────────────────────│
    │mo_read_address   ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────────────────────────│
    │po_read           ││    ┌───┐                                                           │
    │                  ││────┘   └───────────────────────────────────────────────────────────│
    │pi_read_available ││────────────────────────────────────────────────────────────────────│
    │                  ││                                                                    │
    │                  ││────────────────────────────────────────────────────────────────────│
    │pi_read_data      ││ 20                                                                 │
    │                  ││────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────────────────────────│
    │po_read_address   ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────────────────────────│
    └──────────────────┘└────────────────────────────────────────────────────────────────────┘ |}]
;;

let%expect_test "RETURN" = simulate_instruction RETURN;
  [%expect {|
    ┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────┐
    │clock             ││┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ │
    │                  ││  └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─│
    │                  ││────┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───│
    │state             ││ 0  │1  │2  │3  │4  │5  │6  │7  │15 │16 │17 │18 │19 │20 │21 │22 │23 │
    │                  ││────┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───│
    │                  ││────────────────────────────────────────────────────────────────────│
    │Accu              ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────────────────────────│
    │Env               ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────────────────────────│
    │                  ││────────────────┬───────────────────────────────────┬───────────────│
    │Pc                ││ 0              │4                                  │30             │
    │                  ││────────────────┴───────────────────────────────────┴───────────────│
    │                  ││────────────────────────────────────────────────┬───────────────────│
    │Sp                ││ 0                                              │8                  │
    │                  ││────────────────────────────────────────────────┴───────────────────│
    │                  ││────────────────────────────────────────────────────────────────────│
    │Extra_args        ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────────────────────────│
    │mo_read           ││                                                                    │
    │                  ││────────────────────────────────────────────────────────────────────│
    │mi_read_available ││────────────────────────────────────────────────────────────────────│
    │                  ││                                                                    │
    │                  ││────────────────────────────────────────────────────────────────────│
    │mi_read_data      ││ 10                                                                 │
    │                  ││────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────────────────────────│
    │mo_read_address   ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────────────────────────│
    │po_read           ││    ┌───┐                                                           │
    │                  ││────┘   └───────────────────────────────────────────────────────────│
    │pi_read_available ││────────────────────────────────────────────────────────────────────│
    │                  ││                                                                    │
    │                  ││────────────────────────────────────────────────────────────────────│
    │pi_read_data      ││ 20                                                                 │
    │                  ││────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────────────────────────│
    │po_read_address   ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────────────────────────│
    │so_read           ││                                    ┌───┐               ┌───┐       │
    │                  ││────────────────────────────────────┘   └───────────────┘   └───────│
    │si_read_available ││────────────────────────────────────────────────────────────────────│
    │                  ││                                                                    │
    │                  ││────────────────────────────────────────────────────────────────────│
    │si_read_data      ││ 30                                                                 │
    │                  ││────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────────────┬───┬───────│
    │so_read_address   ││ 0                                                      │1  │0      │
    │                  ││────────────────────────────────────────────────────────┴───┴───────│
    └──────────────────┘└────────────────────────────────────────────────────────────────────┘ |}]
